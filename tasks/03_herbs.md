# 03 — Herbs (Alphabetical Cards + Index Bar)

## Objective
Implement a high‑performance Herbs screen that can render ~500–1,000+ herbs using a virtualized list. Each herb appears as a card with an image placeholder and key metadata. Provide an alphabetical index bar on the right that lets users quickly jump to the corresponding letter section.

## Data Source
- Mock data: `tasks/03_herbs.jsonl` (one JSON object per line).
- Suggested fields (from sample):
  - `name_zh` (Chinese name), `name_pinyin`, `desc_en` (family), `property`, `flavor[]`, `meridian_tropism[]`, `indications[]`, `source_url`.

### TypeScript Model
```ts
export type Herb = {
  id: string;           // stable unique id (e.g., hash or index)
  slug: string;         // derived from pinyin or zh (kebab‑case)
  nameZh: string;       // name_zh
  namePinyin: string;   // name_pinyin
  family?: string;      // desc_en
  property?: string;    // property
  flavor?: string[];    // flavor
  meridians?: string[]; // meridian_tropism
  indications?: string[]; // indications
  sourceUrl?: string;   // source_url
};
```

## Deliverables
- Route: `app/(protected)/herbs/index.tsx` (Expo Router)
- Screen: `src/screens/Herbs/HerbsScreen.tsx`
- Components:
  - `src/screens/Herbs/components/HerbCard.tsx`
  - `src/screens/Herbs/components/AlphaIndexBar.tsx`
- Hook: `src/screens/Herbs/hooks/useHerbsData.ts`
- Data (generated): `src/data/herbs.ts` exporting `HERBS: Herb[]`
- Asset: `assets/images/herbs/placeholder.png` (used for all items initially)

## UI Requirements
- Layout: Full‑width, vertically scrolling `SectionList` grouped by first letter of the pinyin (A–Z, `#` for non‑alphabet).
- Item: “Card” row (≈96–120px tall) with:
  - Left: square image (56–64px) using placeholder
  - Right: herb name (Chinese), pinyin subtitle, small meta row (e.g., family or 1–2 tags like property/flavor)
- Section headers: Letter titles (A, B, C…)
- Alphabetical index bar (right overlay):
  - A–Z (and `#`) vertically stacked; press a letter to jump to that section.
  - Optional: drag across letters to scroll continuously (v2)
- Safe areas: honor top/bottom insets; index bar sits within safe area.

## Performance
- Use `SectionList` with virtualization:
  - `initialNumToRender={16}`, `windowSize={10}`, `maxToRenderPerBatch={24}`
  - `removeClippedSubviews` (native only), `keyExtractor`
- Keep cards lightweight; memoize `renderItem` with `useCallback` and wrap `HerbCard` in `React.memo`.
- Precompute sections with `useMemo`.

## Navigation
- Add a “Herbs” entry from Home (e.g., tapping the Herbs category box) to route to `/(protected)/herbs`.

## Data Ingestion (from JSONL)
Create a small build script to convert `tasks/03_herbs.jsonl` into a typed TS module.

```ts
// scripts/build-herbs.ts
import fs from 'fs';
import readline from 'readline';
import path from 'path';

function slugify(input: string) {
  return input
    .toLowerCase()
    .replace(/[^a-z0-9]+/gi, '-')
    .replace(/^-+|-+$/g, '');
}

async function main() {
  const input = path.resolve('tasks/03_herbs.jsonl');
  const rl = readline.createInterface({ input: fs.createReadStream(input) });
  const out: any[] = [];
  let i = 0;
  for await (const line of rl) {
    if (!line.trim()) continue;
    const raw = JSON.parse(line);
    const id = String(++i);
    const nameZh = raw.name_zh || '';
    const namePinyin = raw.name_pinyin || '';
    const slug = slugify(namePinyin || nameZh || id);
    out.push({
      id,
      slug,
      nameZh,
      namePinyin,
      family: raw.desc_en,
      property: raw.property,
      flavor: raw.flavor,
      meridians: raw.meridian_tropism,
      indications: raw.indications,
      sourceUrl: raw.source_url,
    });
  }
  const header = `// generated by scripts/build-herbs.ts\nexport type Herb = { id: string; slug: string; nameZh: string; namePinyin: string; family?: string; property?: string; flavor?: string[]; meridians?: string[]; indications?: string[]; sourceUrl?: string; };\n`;
  const body = `export const HERBS: Herb[] = ${JSON.stringify(out, null, 2)} as const;\n`;
  fs.mkdirSync('src/data', { recursive: true });
  fs.writeFileSync('src/data/herbs.ts', header + body);
  console.log(`Wrote ${out.length} herbs to src/data/herbs.ts`);
}

main().catch((e) => { console.error(e); process.exit(1); });
```

Run locally:
- `ts-node scripts/build-herbs.ts` or `node scripts/build-herbs.ts` (if you switch to JS)

## Grouping & Index
```ts
// src/screens/Herbs/hooks/useHerbsData.ts
import { useMemo } from 'react';
import { HERBS, type Herb } from '@/data/herbs';

export type Section = { title: string; data: Herb[] };

function normalizeLetter(s: string) {
  const c = (s || '').trim().charAt(0).toUpperCase();
  return /[A-Z]/.test(c) ? c : '#';
}

export function useHerbsSections() {
  return useMemo(() => {
    const buckets: Record<string, Herb[]> = {};
    for (const h of HERBS) {
      const key = normalizeLetter(h.namePinyin || h.nameZh);
      (buckets[key] ||= []).push(h);
    }
    const letters = Object.keys(buckets).sort((a, b) => (a === '#' ? 1 : b === '#' ? -1 : a.localeCompare(b)));
    const sections: Section[] = letters.map((l) => ({
      title: l,
      data: buckets[l].slice().sort((a, b) => (a.namePinyin || a.nameZh).localeCompare(b.namePinyin || b.nameZh)),
    }));
    return { sections, letters };
  }, []);
}
```

## Herb Card
```tsx
// src/screens/Herbs/components/HerbCard.tsx
import React from 'react';
import { Image, Pressable, StyleSheet, Text, View } from 'react-native';
import type { Herb } from '@/data/herbs';

export type HerbCardProps = { herb: Herb; onPress?: (herb: Herb) => void };

export const HerbCard = React.memo(({ herb, onPress }: HerbCardProps) => {
  return (
    <Pressable style={styles.card} onPress={() => onPress?.(herb)} accessibilityRole="button" accessibilityLabel={`Herb ${herb.nameZh}`}>
      <Image source={require('../../../../assets/images/herbs/placeholder.png')} style={styles.image} />
      <View style={styles.meta}>
        <Text style={styles.title}>{herb.nameZh}</Text>
        <Text style={styles.subtitle}>{herb.namePinyin}</Text>
        {!!herb.family && <Text style={styles.caption}>{herb.family}</Text>}
      </View>
    </Pressable>
  );
});

const styles = StyleSheet.create({
  card: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#fff',
    padding: 12,
    borderRadius: 12,
    marginHorizontal: 16,
    marginVertical: 6,
    shadowColor: '#000',
    shadowOpacity: 0.06,
    shadowRadius: 6,
    shadowOffset: { width: 0, height: 2 },
    elevation: 2,
  },
  image: { width: 56, height: 56, borderRadius: 8, backgroundColor: '#f1f1f1' },
  meta: { marginLeft: 12, flex: 1 },
  title: { fontSize: 16, fontWeight: '600', color: '#111' },
  subtitle: { marginTop: 2, fontSize: 13, color: '#555' },
  caption: { marginTop: 2, fontSize: 12, color: '#777' },
});
```

## Alphabet Index Bar
```tsx
// src/screens/Herbs/components/AlphaIndexBar.tsx
import React from 'react';
import { Pressable, StyleSheet, Text, View } from 'react-native';

export function AlphaIndexBar({ letters, onSelect }: { letters: string[]; onSelect: (index: number) => void }) {
  return (
    <View pointerEvents="box-none" style={styles.wrap}>
      <View style={styles.col}>
        {letters.map((l, i) => (
          <Pressable key={l} style={({ pressed }) => [styles.item, pressed && styles.pressed]} onPress={() => onSelect(i)} accessibilityRole="button" accessibilityLabel={`Jump to ${l}`}>
            <Text style={styles.txt}>{l}</Text>
          </Pressable>
        ))}
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  wrap: { position: 'absolute', right: 0, top: 0, bottom: 0, justifyContent: 'center', paddingRight: 4 },
  col: { alignItems: 'center', paddingVertical: 8, paddingHorizontal: 2, borderRadius: 8, backgroundColor: 'rgba(255,255,255,0.7)' },
  item: { paddingVertical: 2, paddingHorizontal: 4, borderRadius: 4 },
  pressed: { backgroundColor: 'rgba(0,0,0,0.06)' },
  txt: { fontSize: 11, color: '#333' },
});
```

## Screen Implementation
```tsx
// src/screens/Herbs/HerbsScreen.tsx
import React, { useRef } from 'react';
import { SafeAreaView } from 'react-native-safe-area-context';
import { SectionList, SectionListData, SectionListRenderItem, StyleSheet, Text, View } from 'react-native';
import { HerbCard } from './components/HerbCard';
import { useHerbsSections } from './hooks/useHerbsData';
import type { Herb } from '@/data/herbs';
import { AlphaIndexBar } from './components/AlphaIndexBar';

export default function HerbsScreen() {
  const { sections, letters } = useHerbsSections();
  const listRef = useRef<SectionList<Herb>>(null);

  const onSelectIndex = (sectionIndex: number) => {
    const s = sections[sectionIndex];
    if (!s) return;
    listRef.current?.scrollToLocation({ sectionIndex, itemIndex: 0, animated: true, viewPosition: 0 });
  };

  const renderItem: SectionListRenderItem<Herb> = ({ item }) => <HerbCard herb={item} />;
  const renderSectionHeader = ({ section }: { section: SectionListData<Herb> }) => (
    <View style={styles.header}><Text style={styles.headerTxt}>{section.title}</Text></View>
  );

  return (
    <SafeAreaView style={styles.container} edges={['top', 'left', 'right']}>
      <View style={{ flex: 1 }}>
        <SectionList
          ref={listRef}
          sections={sections as any}
          keyExtractor={(item) => item.id}
          renderItem={renderItem}
          renderSectionHeader={renderSectionHeader}
          stickySectionHeadersEnabled
          initialNumToRender={16}
          windowSize={10}
          maxToRenderPerBatch={24}
          removeClippedSubviews
          contentContainerStyle={{ paddingBottom: 24 }}
        />
        <AlphaIndexBar letters={letters} onSelect={onSelectIndex} />
      </View>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: '#fafafa' },
  header: { backgroundColor: '#f2f2f7', paddingVertical: 6, paddingHorizontal: 16 },
  headerTxt: { fontSize: 13, fontWeight: '600', color: '#333' },
});
```

## Route Wiring (Expo Router)
```ts
// app/(protected)/herbs/index.tsx
export { default } from '../../../src/screens/Herbs/HerbsScreen';
```

- From Home, navigate with: `router.push('/(protected)/herbs');`

## Assets
- Add `assets/images/herbs/placeholder.png` (square ~128×128, neutral background). All cards use this placeholder initially.
- Optional v2: Generate a `slug -> require(path)` image map during build to attach per‑herb images.

## Acceptance Criteria
- Renders a list of ~500–1,000+ herb cards smoothly with virtualization.
- Cards show: placeholder image, Chinese name, pinyin, and optional family.
- Section headers display A–Z (and `#` where applicable).
- Right‑side alphabetical index bar is present and tapping a letter scrolls to that section.
- Safe areas respected; content looks correct on common iOS/Android sizes.
- Basic accessibility labels on cards and index bar items.

## Test Plan
- Unit
  - `useHerbsData` groups by initial, sorts sections and items deterministically.
  - Letters array covers all sections and orders `#` last.
- Component
  - `HerbCard` renders required texts; stable keyExtractor uses `id`.
  - SectionList renders N items from mock; pressing an index letter triggers `scrollToLocation`.
- Performance
  - Scrolling remains smooth on 1k items; no excessive re‑renders (memoized card, stable callbacks).

## Notes & Future Enhancements
- Add search/filter at the top of Herbs list (debounced).
- Support drag on index bar (Gesture Handler) with a preview bubble.
- Add detail screen on card press (route `/(protected)/herbs/[slug]`).
- Consider `getItemLayout` if item heights become fixed, to further optimize jumps.

---

Implementation follows the project’s Expo + TypeScript best practices: functional components with hooks, feature‑based folder structure, and virtualization for large lists.

